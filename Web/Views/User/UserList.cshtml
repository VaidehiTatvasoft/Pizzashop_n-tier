@{
  ViewData["Title"] = "UserList";
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@model List<Entity.ViewModel.UserList>
<div class="d-flex justify-content-between m-3 p-3">
    <div><h4>Users</h4></div>
    <div class="d-flex">
        <input type="text" id="searchInput" class="form-control me-2" placeholder="Search" />
        <a href="@Url.Action("AddUser", "User")" class="btn btn-primary">+ Add User</a>
    </div>
</div>
<div class="card">
<table class="table">
    <thead>
        <tr>
            <th onclick="sortTable('Name')">Name <span id="sortIconName">↑↓</span></th>
            <th>Email</th>
            <th>Phone</th>
            <th onclick="sortTable('Role')">Role <span id="sortIconRole">↑↓</span></th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="userTableBody">
        @foreach (var user in Model)
        {
            <tr>
                <td>@user.Name</td>
                <td>@user.Email</td>
                <td>@user.Phone</td>
                <td>@user.RoleName</td>
                <td><span class="badge-@user.Status">@user.Status</span></td>
                <td>
                    <a class="bi bi-pen m-1" href="@Url.Action("EditUser", new { id = user.Id })"></a>
                    <a class="bi bi-trash m-1" href="javascript:void(0)" onclick="confirmDelete(@user.Id)"></a>
                    <form id="deleteForm-@user.Id" method="post" action="@Url.Action("DeleteUser", "User", new { id = user.Id })" style="display:none;">
                        @Html.AntiForgeryToken()
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="d-flex justify-content-end align-items-center">
    <label>Items per page</label>
     <select id="pageSizeSelect" class="form-select form-select-sm d-inline-block w-auto" onchange="changePageSize()">
            <option value="5" selected="@(ViewBag.PageSize == 5 ? "selected" : null)">5</option>
            <option value="10" selected="@(ViewBag.PageSize == 10 ? "selected" : null)">10</option>
            <option value="20" selected="@(ViewBag.PageSize == 20 ? "selected" : null)">20</option>
        </select>
    <label>Showing @(ViewBag.CurrentPage * ViewBag.PageSize - ViewBag.PageSize + 1)-@(ViewBag.CurrentPage * ViewBag.PageSize) of @ViewBag.TotalUsers</label>
    <nav>
        <ul class="pagination mb-0">
            <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="javascript:void(0)" onclick="changePage(@(ViewBag.CurrentPage - 1))">←</a>
            </li>
            <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                <a class="page-link" href="javascript:void(0)" onclick="changePage(@(ViewBag.CurrentPage + 1))">→</a>
            </li>
        </ul>
    </nav>
</div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this user?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
    document.getElementById("searchInput").addEventListener("input", debounce(function () {
        let query = this.value.toLowerCase();
        let rows = document.querySelectorAll("#userTableBody tr");

        rows.forEach(row => {
            let name = row.cells[0].textContent.toLowerCase();
            let role = row.cells[1].textContent.toLowerCase();
            row.style.display = (name.includes(query) || role.includes(query)) ? "" : "none";
        });
    }, 300));

    function debounce(func, delay) {
        let timeout;
        return function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, arguments), delay);
        };
    }

    function sortTable(column) {
        let table = document.querySelector("table tbody");
        let rows = Array.from(table.rows);
        let isAscending = table.getAttribute("data-sort") !== column;

        rows.sort((a, b) => {
            let valA = a.cells[column === "Name" ? 0 : 1].textContent.trim().toLowerCase();
            let valB = b.cells[column === "Name" ? 0 : 1].textContent.trim().toLowerCase();
            return isAscending ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });

        rows.forEach(row => table.appendChild(row));
        table.setAttribute("data-sort", isAscending ? column : "");

        document.getElementById(`sortIcon${column}`).textContent = isAscending ? "↑↓" : "↑↓";
    }

    function changePageSize() {
        let pageSize = document.getElementById("pageSizeSelect").value;
        window.location.href = `?pageSize=${pageSize}`;
    }

    function changePage(page) {
        let pageSize = document.getElementById("pageSizeSelect").value;
        window.location.href = `?page=${page}&pageSize=${pageSize}`;
    }

    function confirmDelete(userId) {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        document.getElementById("confirmDeleteButton").onclick = function() {
            document.getElementById(`deleteForm-${userId}`).submit();
        };
        modal.show();
    }
</script>