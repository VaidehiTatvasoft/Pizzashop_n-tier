@using Entity.Data
@model List<MenuCategory>

<div class="container-fluid p-2">
    <div class="menu">
        <h2 style="color: #0066A7;">Menu</h2>
        <div>
            <div class="mb-4 justify-content-center align-items-center flex-wrap">
                @Html.Partial("_MenuTabs")
            </div>
            <section>
                <div class="row mx-0">
                    <aside class="col-md-2" style="background-image: linear-gradient(to right, white, #f2f2f2);">
                        <!-- Section header -->
                        <div class="d-flex flex-wrap justify-content-between align-items-center p-3"
                            style="color: #0066A7;">
                            <h5>Category</h5>
                            <i class="cat-i fa-regular fa-square-plus add-category"  data-bs-toggle="modal"
                             data-bs-target="#addCategoryModal"style="height: 30px; width:30px;"></i>
                            <div class="modal fade" id="addCategoryModal" tabindex="-1"
                                aria-labelledby="addCategoryModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <!-- Content will be loaded here via AJAX -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-auto" style="max-height: 500px;">
                            @foreach (var category in Model)
                            {
                                <div class="category-wrapper">
                                    <a class="nav-link menu-sidebar category-link" href="javascript:void(0);"
                                        data-category-id="@category.Id">
                                        <span class="category-item">
                                            <i class="fa-solid fa-grip-vertical"></i> @category.Name
                                            <i class="bi bi-pen m-1 edit-icon" data-id="@category.Id"></i>
                                            <i class="bi bi-trash m-1 delete-icon" onclick="confirmDelete(@category.Id)"></i>
                                        </span>
                                    </a>
                                    <form id="deleteform-@category.Id" method="post"
                                        action="@Url.Action("DeleteCategory", "Menu", new { id = @category.Id })"
                                        style="display: none;">
                                        @Html.AntiForgeryToken()
                                    </form>
                                </div>
                            }
                        </div>
                        <div class="modal fade" id="editCategoryModal" tabindex="-1"
                            aria-labelledby="editCategoryModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <!-- Content will be loaded here via AJAX -->
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                            aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="deleteModalLabel">Delete Confirmation</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class = "modal-body d-flex flex-column justify-content-center align-items-center">
                                        <img src = "@Url.Content("~/assets/warning.png")" alt=""
                                            style="height: 40px; width: auto;">
                                        Are you sure you want to delete this Category?
                                    </div>
                                    <div class="d-flex justify-content-center align-items-center"
                                        style="gap: 10px; margin-bottom: 20px;">
                                        <button type="button" class="btn" id="confirmDeleteButton"
                                            style="height: 40px; width: 100px; background-color: #006098; color: white;">Yes</button>
                                        <button type="button" class="btn" data-bs-dismiss="modal"
                                            style="height: 40px; width: 100px; background-color: white; border: 1px solid #006098;">No</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <div class="col-md-9 border-start border-primary bg-white">
                        <div>
                            <!-- table header -->
                            <h5 class="p-3" style="color: #0066A7;">Items</h5>

                            <!-- Items Table -->
                            <div id="item-list">
                                @await Html.PartialAsync("_MenuItemsPartial", ViewBag.MenuItems as List<MenuItem>)
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

@section Scripts {
            <script>
                function confirmDelete(categoryId) {
                    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    document.getElementById("confirmDeleteButton").onclick = function () {
                        document.getElementById(`deleteform-${categoryId}`).submit();
                    };
                    modal.show();
                }

                $(document).ready(function () {
                    var successMessage = '@TempData["SuccessMessage"]';
                    var errorMessage = '@TempData["ErrorMessage"]';

                    if (successMessage) {
                        toastr.success(successMessage);
                    }
                    if (errorMessage) {
                        toastr.error(errorMessage);
                    }

                    $(document).on('click', '.add-category', function () {
                        $.ajax({
                            type: "GET",
                            url: "/menu/addcategory",
                            dataType: "html",
                            headers: {
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (data) {
                                $("#addCategoryModal").find('.modal-content').html(data);
                                $('#addCategoryModal').modal('show');
                            },
                            error: function (xhr, status, error) {
                                if (xhr.status === 401) {
                                    toastr.error("You are not authorized to perform this action.");
                                } else if (xhr.status === 403) {
                                    toastr.error("You are forbidden from accessing this resource.");
                                } else {
                                    console.error("Error loading category form:", status, error);
                                    alert("Failed to load category form.");
                                }
                            }
                        });
                    });

                    $(document).on('click', '.category-link', function (e) {
                        e.preventDefault();
                        var categoryId = $(this).data('category-id');
                        $('.category-link').removeClass('active');
                        $(this).addClass('active');
                        $.ajax({
                            url: '@Url.Action("MenuList", "Menu")',
                            type: 'GET',
                            data: { categoryId: categoryId },
                            success: function (result) {
                                $('#item-list').html($(result).find('#item-list').html());
                            },
                            error: function (xhr, status, error) {
                                if (xhr.status === 401) {
                                    toastr.error("You are not authorized to perform this action.");
                                } else if (xhr.status === 403) {
                                    toastr.error("You are forbidden from accessing this resource.");
                                } else {
                                    console.error("Error loading category items:", status, error);
                                    alert("Failed to load category items.");
                                }
                            }
                        });
                    });

                    $(document).on('click', '.edit-icon', function () {
                        var id = $(this).data('id');
                        $.ajax({
                            type: "GET",
                            url: "/menu/editcategory/" + id,
                            dataType: "html",
                            headers: {
                                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (data) {
                                $("#editCategoryModal").find('.modal-content').html(data);
                                $('#editCategoryModal').modal('show');
                            },
                            error: function (xhr, status, error) {
                                if (xhr.status === 401) {
                                    toastr.error("You are not authorized to perform this action.");
                                } else if (xhr.status === 403) {
                                    toastr.error("You are forbidden from accessing this resource.");
                                } else {
                                    console.error("Error loading category details:", status, error);
                                    alert("Failed to load category details.");
                                }
                            }
                        });
                    });

                    $('#categoryDropdown').change(function () {
                        var categoryId = $(this).val();
                        if (categoryId) {
                            $.ajax({
                                url: '@Url.Action("MenuList", "Menu")',
                                type: 'GET',
                                data: { categoryId: categoryId },
                                success: function (result) {
                                    $('#item-list').html($(result).find('#item-list').html());
                                },
                                error: function (xhr, status, error) {
                                    if (xhr.status === 401) {
                                        toastr.error("You are not authorized to perform this action.");
                                    } else if (xhr.status === 403) {
                                        toastr.error("You are forbidden from accessing this resource.");
                                    } else {
                                        console.error("Error loading category items:", status, error);
                                        alert("Failed to load category items.");
                                    }
                                }
                            });
                        }
                    });
                });
            </script>
}