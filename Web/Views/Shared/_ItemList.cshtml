@using Entity.Data
@model List<MenuCategory>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    * {
        padding: 0;
        margin: 0;
        
    }

    html,body {
        background-color: #F2F2F2;
    }

    .main {
        background-color: #F2F2F2;
    }

    .container-fluid {
        padding: 0;
    }

    .items {
        color: #0066A7;
        margin-right: 10px;
        margin-left: 10px;
        gap: 5px;
    }

    .fa-square-plus {
        font-size: 30px;
    }

    .add-user {
        background-color: #0066A7;
        color: white;
        height: 50px;
        width: 150px;
        border: none;
        border-radius: 5%;
    }

    .search-box {
        margin-right: 20px;
    }

    .search-btn {
        margin-left: -30px;
    }

    #search {
        height: 50px;
        width: 200px;
        padding: 5px;
        margin-left: 10px;
    }

    #tbl {
        background-color: white;
    }

    .nav-link {
        margin-top: 5px;
    }

    .sidebarr {
        padding: 10px;
    }

    .actv {
        color: #0066A7;
    }

    .normal {
        color: black;
    }

    .nav-link-action {
        display: none;
    }

    .nav-item:hover .nav-link-action {
        display: flex;
    }

    .form-switch .form-check-input {
        background-color: #d6d3d3;
        border: #006098;
        background-image: url(../Images/toggle-icon.svg) !important;
    }

    .form-switch .form-check-input:checked {
        background-color: #006098;
    }

    .cat-list {
        overflow-y: scroll;
    }

    .category-wrapper {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0px 10px 0px;
    }

    .category-link {
        flex-grow: 1;
        text-decoration: none;
        color: inherit;
    }

    .nav-link-action {
        display: none;
    }

    .category-wrapper:hover .nav-link-action {
        display: flex;
        gap: 10px;
    }

    .category-wrapper i {
        cursor: pointer;
    }
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<div class="container-fluid p-2">
    <div class="menu">
        <h2 style="color: #0066A7;">Menu</h2>
        <div>
            <div class="mini-navbar d-flex align-items-start" style="height: 50px; width: 100%; gap: 10px; background-color: #FFFFFF; margin-bottom: 8px;">
                <a asp-controller="Menu" asp-action="MenuList" class="d-flex align-items-center justify-content-center"
                    style="width: 80px; height: 40px; align-self: center; gap: 5px; border-bottom: 1px solid #0066A7; text-decoration: none; color: inherit;">
                    <i class="fa-solid fa-list-ul"></i> Items
                </a>
                <a asp-controller="Modifier" asp-action="ModifiersList"
                    class="d-flex align-items-center justify-content-center"
                    style="width: 80px; height: 40px; align-self: center; gap: 5px; border-bottom: 1px solid #0066A7; text-decoration: none; color: inherit;">
                    <i class="fa-solid fa-sliders"></i> Modifiers
                </a>
            </div>
            <div class="main-content row" style="margin-left: 0; margin-right: 0;">
                <div class="sidebarr col-lg-2 text-dark"
                    style="background-image: linear-gradient(to right, white, #f2f2f2);">
                    <div href="/" class="text-decoration-none d-flex justify-content-between align-items-center"
                        style="color: #0066A7;">
                        <h4 class="cat">Category</h4>
                        <i class="cat-i fa-regular fa-square-plus add-category" data-bs-toggle="modal"
                            data-bs-target="#addCategoryModal"></i>
                        <div class="modal fade" id="addCategoryModal" tabindex="-1"
                            aria-labelledby="addCategoryModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <!-- Content will be loaded here via AJAX -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-auto" style="max-height: 500px;">
                        @foreach (var category in Model)
                        {
                            <div class="category-wrapper">
                                <a class="nav-link menu-sidebar category-link" href="javascript:void(0);"
                                    data-category-id="@category.Id">
                                    <span class="category-item">
                                        <i class="fa-solid fa-grip-vertical"></i> @category.Name
                                    </span>
                                </a>
                                <div class="nav-link-action">
                                    <a href="javascript:void(0);" data-id="@category.Id" class="edit-btn edit-category"
                                        style="text-decoration: none; color: inherit;">
                                        <i class="fa-solid fa-pencil m-1" data-bs-toggle="modal"
                                            data-bs-target="#editCategoryModal"></i>
                                    </a>
                                    <a href="javascript:void(0)" onclick="confirmDelete(@category.Id)"
                                        style="text-decoration: none; color: inherit;" class="dlt-btn">
                                        <i class="fa-solid fa-trash m-1"></i>
                                    </a>
                                </div>
                                <form id="deleteform-@category.Id" method="post"
                                    action="@Url.Action("DeleteCategory", "Menu", new { id = @category.Id })"
                                    style="display: none;">
                                    @Html.AntiForgeryToken()
                                </form>
                            </div>
                        }
                    </div>
                    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <!-- Content will be loaded here via AJAX -->
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel">Deletion Confirmation</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                                    <img src="@Url.Content("~/images/warning.png")" alt=""
                                        style="height: 40px; width: auto;">
                                    Are you sure you want to delete this Category?
                                </div>
                                <div class="d-flex justify-content-center align-items-center"
                                    style="gap: 10px; margin-bottom: 20px;">
                                    <button type="button" class="btn" id="confirmDeleteButton"
                                        style="height: 40px; width: 100px; background-color: #006098; color: white;">Yes</button>
                                    <button type="button" class="btn" data-bs-dismiss="modal"
                                        style="height: 40px; width: 100px; background-color: white; border: 1px solid #006098;">No</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-column p-3 col-lg-10" id="tbl">
                    <h4 class="items">Items</h4>

                    <div class="sidebarr-dropdown d-lg-none mb-3">
                        <select class="form-control" id="categoryDropdown">
                            <option value="">Select Category</option>
                            @foreach (var category in Model)
                            {
                                if (ViewBag.SelectedCategory == category.Id)
                                {
                                    <option value="@category.Id" selected>@category.Name</option>
                                }
                                else
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div id="item-list">
                        @await Html.PartialAsync("~/Views/Menu/_MenuItemsPartial.cshtml", ViewBag.MenuItems as
                        List<MenuItem>)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function confirmDelete(categoryId) {
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            document.getElementById("confirmDeleteButton").onclick = function () {
                document.getElementById(`deleteform-${categoryId}`).submit();
            };
            modal.show();
        }

        $(document).ready(function () {

            $(document).on('click', '.add-category', function () {
                $.ajax({
                    type: "GET",
                    url: "/menu/addcategory",
                    dataType: "html",
                    success: function (data) {
                        $("#addCategoryModal").find('.modal-content').html(data);
                        $('#addCategoryModal').modal('show');
                    },
                    error: function () {
                        alert("Failed to load category form.");
                    }
                });
            });

            $(document).on('click', '.category-link', function (e) {
                e.preventDefault();
                var categoryId = $(this).data('category-id');
                $.ajax({
                    url: '@Url.Action("MenuList", "Menu")',
                    type: 'GET',
                    data: { categoryId: categoryId },
                    success: function (result) {
                        $('#item-list').html($(result).find('#item-list').html());
                    }
                });
            });

            $(document).on('click', '.edit-category', function () {
                var id = $(this).data('id');
                $.ajax({
                    type: "GET",
                    url: "/menu/editcategory/" + id,
                    dataType: "html",
                    success: function (data) {
                        $("#editCategoryModal").find('.modal-content').html(data);
                        $('#editCategoryModal').modal('show');
                    },
                    error: function () {
                        alert("Failed to load category details.");
                    }
                });
            });

            $('#categoryDropdown').change(function () {
                var categoryId = $(this).val();
                if (categoryId) {
                    $.ajax({
                        url: '@Url.Action("MenuList", "Menu")',
                        type: 'GET',
                        data: { categoryId: categoryId },
                        success: function (result) {
                            $('#item-list').html($(result).find('#item-list').html());
                        }
                    });
                }
            });
        });

        $(document).on('click', '.add-item', function () {
            $.ajax({
                type: "GET",
                url: "/menu/additem",
                dataType: "html",
                success: function (data) {
                    $("#addModal").find('.modal-content').html(data);
                    $('#addModal').modal('show');
                },
                error: function (xhr, status, error) {
                    alert("Failed to load item details");
                }
            });
        });

        $(document).on('click', '.edit-item', function () {
            var id = $(this).data('id');
            $.ajax({
                type: "GET",
                url: "/menu/edititem/" + id,
                data: { id: id },
                success: function (data) {
                    $('#editItemModal .modal-content').html(data);
                    $('#editItemModal').modal('show');
                },
                error: function () {
                    alert("Failed to load item details.");
                }
            });
        });

        $('#editItemModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-content').html('');
        });

        $('#addModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-content').html('');
        });

        @if (TempData["SuccessMessage"] != null)
        {
            <text>
                toastr.success("@TempData["SuccessMessage"]");
            </text>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <text>
                toastr.error("@TempData["ErrorMessage"]");
            </text>
        }
    </script>
}